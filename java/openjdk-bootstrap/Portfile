# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0

name                openjdk-bootstrap
version             1.0
revision            0
maintainers         nomaintainer
license             GPL-2+

if {${subport} eq ${name}} {
    PortGroup          stub 1.0

    supported_archs     noarch
    set meta true
    description        "Meta port encompassing binary OpenJDK releases"
    long_description   {*}${description}
    homepage           

    notes {
        The openjdk-distributions port is not installable, but recommends users to install\
        the latest Long Term Support (LTS) subport
    }
}

subport openjdk7-ppc {
    version             7u241
    revision            0
    supported_archs     ppc ppc64
    homepage            
    set build 2012-03-14
    description         OpenJDK 7 ppc
    long_description    {*}${description}
    master_sites        https://macintoshgarden.org/sites/macintoshgarden.org/files/apps \
                        http://mirror.macintosharchive.org/macintoshgarden.org/files/apps \
                        http://old.macintosh.garden/apps \
                        ftp://repo1.macintoshgarden.org/Garden/apps
    checksums           rmd160  872bea18c8c153d0509d2d18ebe6da6a71161e3f \
                        sha256  0d3ffaa7c5a2873ec26fc97ce1f592bafa18e3ae52605f0a2ba039a75d4860a8 \
                        size    54392585
    distname            openjdk7u2-macppc-fcs-${build}
    distfiles           ${distname}.tar_.bz2
    use_bzip2           yes
    worksrcdir          ${distname}
    use_xcode           no
    use_configure       no
    depends_lib         port:freetype
    build {}


    set path ${prefix}/Library/Java/JavaVirtualMachines/${name}
    destroot {
        xinstall -m 755 -d ${destroot}${path}
        copy ${worksrcpath}/ASSEMBLY_EXCEPTION ${destroot}${path}
        copy ${worksrcpath}/bin ${destroot}${path}
        copy ${worksrcpath}/demo ${destroot}${path}
        copy ${worksrcpath}/include ${destroot}${path}
        copy ${worksrcpath}/jre ${destroot}${path}
        copy ${worksrcpath}/lib ${destroot}${path}
        copy ${worksrcpath}/LICENSE ${destroot}${path}
        copy ${worksrcpath}/man ${destroot}${path}
        copy ${worksrcpath}/release ${destroot}${path}
        copy ${worksrcpath}/sample ${destroot}${path}
        copy ${worksrcpath}/src.zip ${destroot}${path}
        copy ${worksrcpath}/THIRD_PARTY_README ${destroot}${path}
    }
    destroot.violate_mtree  yes

    post-destroot {
        system "install_name_tool -change /usr/X11/lib/libfreetype.6.dylib ${prefix}/lib/libfreetype.6.dylib ${destroot}${path}/jre/lib/ppc/libfontmanager.dylib"
    }
}

subport openjdk7-bootstrap {
    version             7u241
    revision            0
    supported_archs     ppc ppc64 i386 x86_64
    description         OpenJDK 7 bootstrap
    long_description    {*}${description}
    homepage            https://openjdk.java.net/
    master_sites        https://git.openjdk.org/jdk7u/archive/refs/tags
    distname            jdk${version}-ga
    worksrcdir          jdk7u-${distname}
    checksums           rmd160  05869c70ab85be57bca111cb8205e985d8f0c171 \
                        sha256  bc203dc977b102316fa32224cd98d8285cc45185e8c07c283bfb891d3293a791 \
                        size    69581503
    depends_lib         port:freetype
    depends_build       port:gmake \
                        port:pkgconfig \
                        port:apache-ant \
                        port:unzip \
                        port:zip
    pre-patch {
        reinplace "s|  REQUIRED_COMPILER_VERSION   = GCC4| |g" ${worksrcpath}/jdk/make/common/shared/Defs-versions.gmk
        reinplace "s|  REQUIRED_CC_VER             = 4.2.1| |g" ${worksrcpath}/jdk/make/common/shared/Defs-versions.gmk
        reinplace "s|  REQUIRED_COMPILER_NAME      = GCC4| |g" ${worksrcpath}/jdk/make/common/shared/Defs-versions.gmk
        reinplace "s|11.2|9.0|g" ${worksrcpath}/jdk/make/common/shared/Defs-versions.gmk
        reinplace "s|10.7.2|10.5.0|g" ${worksrcpath}/jdk/make/common/shared/Defs-versions.gmk
        reinplace "s|1.7.1|1.6.0|g" ${worksrcpath}/jdk/make/common/shared/Defs-versions.gmk
        reinplace "s|2.3.0|2.12.1|g" ${worksrcpath}/jdk/make/common/shared/Defs-versions.gmk
    }
    if {${configure.build_arch} eq "i386" || ${configure.build_arch} eq "x86_64"} {
        depends_build-append       port:openjdk6-apple
        set bootdir ${prefix}/Library/Java/JavaVirtualMachine/1.6.0.jdk/Contents/Home
    } elseif {${configure.build_arch} eq "ppc" || ${configure.build_arch} eq "ppc64"} {
        depends_build-append       port:openjdk7-ppc
        depends_lib-append         port:libffi
        set bootdir ${prefix}/Library/Java/JavaVirtualMachine/openjdk7-ppc
    }
    use_configure       no
    configure.compiler  gcc
    build.type          gnu
    build.args          ALLOW_DOWNLOADS=true \
                        ALT_BOOTDIR=${bootdir} \
                        ALT_JDK_IMPORT_PATH=${bootdir} \
                        ALT_FREETYPE_HEADERS_PATH=${prefix}/include \
                        ALT_FREETYPE_LIB_PATH=${prefix}/lib \
                        ANT_HOME=${prefix}/share/java/apache-ant \
                        NO_DOCS=true \
                        ALT_CUPS_HEADERS_PATH=/usr/include
    if {${configure.build_arch} eq "i386"} {
        use_parallel_build  no
        set jdk_bundle_dir build/bsd-i586/j2sdk-image
    } elseif {${configure.build_arch} eq "x86_64"} {
        depends_build-append       port:openjdk6-apple
        build.args-append          ARCH_DATA_MODEL=64
        use_parallel_build  no
        set jdk_bundle_dir build/bsd-amd64/j2sdk-image
    } elseif {${configure.build_arch} eq "ppc" || ${configure.build_arch} eq "ppc64"} {
        build.args-append          ALT_CACERTS_FILE=/System/Library/Frameworks/JavaVM.framework/Home/lib/security/cacerts \
                                   LIBFFI_CFLAGS="-I${prefix}/include" \
                                   ZERO_BUILD=true \
                                   ZERO_ENDIANNESS=big \
                                   ZERO_LIBARCH=ppc \
                                   ZERO_ARCHDEF=PPC \
                                   ZERO_ARCHFLAG="-arch ppc"
        use_parallel_build  no
        set jdk_bundle_dir build/bsd-ppc/j2sdk-image
    }
    set path ${prefix}/Library/Java/JavaVirtualMachines
    destroot {
        xinstall -m 755 -d ${destroot}${path}
        move ${worksrcpath}/${jdk_bundle_dir} ${destroot}${path}/${name}
    }
}
  


