# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0

name                openjdk-bootstrap
version             1.0
revision            0
maintainers         nomaintainer
license             GPL-2+

if {${subport} eq ${name}} {
    PortGroup          stub 1.0

    supported_archs     noarch
    set meta true
    description        "Meta port encompassing binary OpenJDK releases"
    long_description   {*}${description}
    homepage           

    notes {
        The openjdk-distributions port is not installable, but recommends users to install\
        the latest Long Term Support (LTS) subport
    }
}

subport openjdk7-ppc {
    version             7u2
    revision            0
    supported_archs     ppc ppc64
    homepage            
    set build 2012-03-14
    description         OpenJDK 7 ppc
    long_description    {*}${description}
    master_sites        https://macintoshgarden.org/sites/macintoshgarden.org/files/apps \
                        http://mirror.macintosharchive.org/macintoshgarden.org/files/apps \
                        http://old.macintosh.garden/apps \
                        ftp://repo1.macintoshgarden.org/Garden/apps
    checksums           rmd160  872bea18c8c153d0509d2d18ebe6da6a71161e3f \
                        sha256  0d3ffaa7c5a2873ec26fc97ce1f592bafa18e3ae52605f0a2ba039a75d4860a8 \
                        size    54392585
    distname            openjdk${version}-macppc-fcs-${build}
    distfiles           ${distname}.tar_.bz2
    use_bzip2           yes
    worksrcdir          ${distname}
    use_xcode           no
    use_configure       no
    depends_lib         port:freetype
    build {}


    set path ${prefix}/Library/Java/JavaVirtualMachines/${name}
    destroot {
        xinstall -m 755 -d ${destroot}${path}
        copy ${worksrcpath}/ASSEMBLY_EXCEPTION ${destroot}${path}
        copy ${worksrcpath}/bin ${destroot}${path}
        copy ${worksrcpath}/demo ${destroot}${path}
        copy ${worksrcpath}/include ${destroot}${path}
        copy ${worksrcpath}/jre ${destroot}${path}
        copy ${worksrcpath}/lib ${destroot}${path}
        copy ${worksrcpath}/LICENSE ${destroot}${path}
        copy ${worksrcpath}/man ${destroot}${path}
        copy ${worksrcpath}/release ${destroot}${path}
        copy ${worksrcpath}/sample ${destroot}${path}
        copy ${worksrcpath}/src.zip ${destroot}${path}
        copy ${worksrcpath}/THIRD_PARTY_README ${destroot}${path}
    }
    destroot.violate_mtree  yes

    post-destroot {
        system "install_name_tool -change /usr/X11/lib/libfreetype.6.dylib ${prefix}/lib/libfreetype.6.dylib ${destroot}${path}/jre/lib/ppc/libfontmanager.dylib"
    }
}

subport openjdk7-bootstrap {
    set uver 241
    set build 01
    version             7u241
    revision            0
    supported_archs     ppc ppc64 i386 x86_64
    description         OpenJDK 7 bootstrap
    long_description    {*}${description}
    platforms           darwin
    homepage            https://openjdk.java.net/
    master_sites        https://git.openjdk.org/jdk7u/archive/refs/tags \
                        https://archive.apache.org/dist/ant/binaries/:ant
    distname            jdk${version}-ga
    worksrcdir          jdk7u-${distname}
    set ant_distname apache-ant-1.8.4-bin
    checksums           ${distname}${extract.suffix} \
                            rmd160  05869c70ab85be57bca111cb8205e985d8f0c171 \
                            sha256  bc203dc977b102316fa32224cd98d8285cc45185e8c07c283bfb891d3293a791 \
                            size    69581503
                        ${ant_distname}${extract.suffix} \
                            rmd160  a2aedf433d12c222e348d1e144539a13a6b3ed96 \
                            sha256  562f2212ea08de4f3f46f25e5452aebaaba8e9132f5decd5021da4e073945155 \
                            size    5425171
                        
    depends_lib         port:freetype \
                        port:cups \
                        port:xorg-libX11 \
                        port:xorg-libXtst \
                        port:libiconv
    depends_build       port:gmake \
                        port:pkgconfig \
                        port:ghc \
                        port:ruby

    if {${configure.build_arch} eq "i386" || ${configure.build_arch} eq "x86_64"} {
        depends_build-append       port:openjdk6-apple
        set bootdir ${prefix}/Library/Java/JavaVirtualMachine/1.6.0.jdk/Contents/Home
    } elseif {${configure.build_arch} eq "ppc" || ${configure.build_arch} eq "ppc64"} {
        depends_build-append       port:openjdk7-ppc
        depends_lib-append         port:libffi
        set bootdir ${prefix}/Library/Java/JavaVirtualMachine/openjdk7-ppc
    }
    if {${build_arch} == "i386"} {
        set openjdk_build_arch "i586"
    } elseif {${build_arch} == "ppc64"}
        set openjdk_build_arch "ppc"
    } else {
        set openjdk_build_arch "${build_arch}"
    }
    pre-patch {
        reinplace "s|/usr/bin/ant|${workpath}/apache-ant-${ant_version}/bin/ant|g" \
            "${worksrcpath}/jdk/make/java/jobjc/Makefile" \
            "${worksrcpath}/jdk/src/macosx/native/jobjc/JObjC.xcodeproj/project.pbxproj"
    }
    use_configure       no
    configure.compiler  gcc
    compiler.blacklist-append  macports-clang*
    build.type          gnu
    build.args          LANG=C \
                        CC="${configure.cc}" \
                        CXX="${configure.cxx}" \
                        EXTRA_CFLAGS="-Wno-deprecated-declarations -I\"${filespath}/clang-compat-headers\"" \
                        ALLOW_DOWNLOADS=true \
                        ALT_BOOTDIR=${bootdir} \
                        ALT_JDK_IMPORT_PATH=${bootdir} \
                        ALT_FREETYPE_HEADERS_PATH=${prefix}/include/freetype2 \
                        ALT_FREETYPE_LIB_PATH=${prefix}/lib \
                        ANT_HOME=${prefix}/share/java/apache-ant \
                        NO_DOCS=true \
                        ALT_CUPS_HEADERS_PATH=${prefix}/include \
                        ALT_COMPILER_PATH=${developer_dir}/usr/bin/ \
                        ALWAYS_PASS_TEST_GAMMA=true \
                        ANT_HOME="${workpath}/apache-ant-${ant_version}" \
                        ALT_X11_PATH="${prefix}" \
                        ALT_DEVTOOLS_PATH=/usr \
                        SKIP_COMPARE_IMAGES="true" \
                        SKIP_FASTDEBUG_BUILD="true" \
                        SKIP_DEBUG_BUILD="true" \
                        ZIP_DEBUGINFO_FILES=0 \
                        ENABLE_FULL_DEBUG_SYMBOLS=0 \
                        MILESTONE="fcs" \
                        BUNDLE_NAME="OpenJDK ${jdk_major_version} (MacPorts)" \
                        BUNDLE_INFO="OpenJDK MacPorts ${name}-${version}" \
                        BUNDLE_ID="org.macports.openjdk" \
                        BUNDLE_VENDOR="MacPorts" \
                        JDK_MICRO_VERSION="0_${uver}" \
                        BUILD_NUMBER="b${build}"

    if {${configure.build_arch} eq "i386"} {
        use_parallel_build  no
    } elseif {${configure.build_arch} eq "x86_64"} {
        build.args-append          ARCH_DATA_MODEL=64 \
                                   SA_APPLE_BOOT_JAVA=true
        use_parallel_build  no
    } elseif {${configure.build_arch} eq "ppc" || ${configure.build_arch} eq "ppc64"} {
        build.args-append          ALT_CACERTS_FILE=/System/Library/Frameworks/JavaVM.framework/Home/lib/security/cacerts \
                                   LIBFFI_CFLAGS="-I${prefix}/include" \
                                   ZERO_BUILD=true \
                                   ZERO_ENDIANNESS=big \
                                   ZERO_LIBARCH=ppc \
                                   ZERO_ARCHDEF=PPC \
                                   ZERO_ARCHFLAG="-arch ppc"
        use_parallel_build  no
    }
    set jdk_bundle_dir build/bsd-${openjdk-build-arch}/j2sdk-image
    set path ${prefix}/Library/Java/JavaVirtualMachines
    destroot {
        xinstall -m 755 -d ${destroot}${path}
        move ${worksrcpath}/${jdk_bundle_dir} ${destroot}${path}/${name}
    }
}
  


