# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0

name                openjdk9-bootstrap
version             9
set build 181
revision            0
categories          java devel
supported_archs     x86_64
license             GPL-2+
maintainers         nomaintainer
description         OpenJDK 9 Boot JDK
long_description    OpenJDK 9 Boot JDK to bootstrap Openjdk ports.
homepage            https://openjdk.org/
master_sites        https://github.com/openjdk/jdk9/archive/refs/tags
distname            jdk-${version}+${build}
worksrcdir          jdk9-jdk-${version}-${build}

checksums           rmd160  c0e83afbc87100eb1f6a7e6ebf1c06adc2c6db22 \
                    sha256  99bbfe3af1d8fe2326aca522626411132bf3ddf026fccefb2b01a4340dac4a2a \
                    size    110105407

depends_lib         port:freetype \
                    port:libiconv \
                    port:libffi
depends_build       port:autoconf \
                    port:gmake \
                    port:bash \
                    port:openjdk8-bootstrap \
                    port:pkgconfig

pre-patch {
    reinplace "s|libffi.so.?|libffi.?.dylib|g" ${worksrcpath}/common/autoconf/lib-ffi.m4
    reinplace "s|xmacosx|xwindows|g" ${worksrcpath}/common/autoconf/lib-freetype.m4
    reinplace "s|libffi.so.?|libffi.?.dylib|g" ${worksrcpath}/hotspot/make/copy/Copy-java.base.gmk
    reinplace "s|(void (*)()) function, result, arguments);|CAST_TO_FN_PTR(void (*)(), function), result, arguments);|g" ${worksrcpath}/hotspot/src/cpu/zero/vm/cppInterpreter_zero.cpp
}

patchfiles          zerovm.diff

set tpath /Library/Java
use_configure    yes
configure.cmd       ${prefix}/bin/bash configure
configure.pre_args  --prefix=${tpath}
configure.args      --with-debug-level=release \
                    --with-native-debug-symbols=none \
                    --with-version-string=${version}+${build} \
                    --with-sysroot=`xcrun --sdk macosx --show-sdk-path` \
                    --with-extra-cflags="${configure.cflags}" \
                    --with-extra-cxxflags="${configure.cxxflags}" \
                    --with-extra-ldflags="${configure.ldflags}" \
                    --with-boot-jdk=/Library/Java/JavaVirtualMachines/openjdk8-bootstrap/Contents/Home \
                    --with-freetype=system \
                    --with-freetype-include=${prefix}/include/freetype2 \
                    --with-freetype-lib=${prefix}/lib \
                    --disable-warnings-as-errors \
                    --disable-precompiled-headers \
                    --with-conf-name=openjdk9-bootstrap \
                    --with-jvm-variants=zero \
                    --with-libffi-include=${prefix}/include \
                    --enable-libffi-bundling

if {[option configure.ccache]} {
    # replace MacPorts ccache integration into JDK
    configure.ccache        no
    depends_build-append    path:bin/ccache:ccache
    configure.args-append   --enable-ccache \
                            --with-ccache-dir=${ccache_dir}
}

build.type          gnu
build.target        images
use_parallel_build  no
set jdkn jdk-${version}.jdk
set bundle_dir build/openjdk9-bootstrap/images/jdk-bundle/${jdkn}/Contents

test.run            yes
test.cmd            ${bundle_dir}/Home/bin/java
test.target         --version

set path /Library/Java/JavaVirtualMachines/${name}
destroot {
    xinstall -m 755 -d ${destroot}${path}
    copy ${worksrcpath}/${bundle_dir} ${destroot}${path}
}
destroot.violate_mtree      yes

post-destroot {
    delete ${worksrcpath}
}
