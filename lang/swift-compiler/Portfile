# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0

name                swift-compiler
version             5.8
revision            0
categories          lang
platforms           darwin
supported_archs     x86_64 arm64
license             Apache-2
maintainers         nomaintainer
description         The Swift Programming Language
long_description    Swift is a high-performance system programming language.  It has a clean \
                    and modern syntax, offers seamless access to existing C and Objective-C code \
                    and frameworks, and is memory-safe by default. 
homepage            https://www.swift.org/

use_xcode           yes

depends_fetch       port:git \
                    port:python311

fetch.type          git
git.url             https://github.com/apple/swift.git
git.branch             swift-5.8-RELEASE

fetch {
    system -W ${workpath} "mkdir -p ${worksrcpath}/swift-project"
    system -W ${worksrcpath}/swift-project "${prefix}/bin/git clone ${git.branch} --single-branch ${git.url}"
}

post-fetch {
    system -W ${worksrcpath}/swift-project "utils/update-checkout --clone"
    system -W ${worksrcpath}/swift-project "utils/update-checkout --tag ${git.branch}"
}

depends_build       port:cmake \
                    port:ninja \
                    port:sccache

configure {}

build.cmd           utils/build-script
build.args          --skip-build-benchmarks \
                    --skip-ios --skip-watchos --skip-tvos --swift-darwin-supported-archs "${configure.build_arch}" \
                    --sccache --release --swift-disable-dead-stripping

build.pre_args      
build.post_args     
build.target        
use_parallel_build  no

if {${configure.build_arch} eq "arm64" } {
    build.args-append          --bootstrapping=off
}

destroot {
    xinstall ${destroot}${prefix}/share/lang
    move ${worksrcpath}/swift-project/build/Ninja-RelWithDebInfoAssert/swift-macosx-${configure.build_arch} ${destroot}${prefix}/share/lang/${name}
    ln -s ../share/lang/${name}/bin/swift-frontend ${destroot}${prefix}/bin/swift-frontend
}
